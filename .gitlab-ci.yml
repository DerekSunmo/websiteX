# 该文件只供 jihulab 进行 CD 部署
# 详情请看: https://docs.gitlab.com/ee/ci/yaml/index.html

image: alpine:latest

stages: # List of stages for jobs, and their order of execution
  - deploy

deploy-site:
  stage: deploy
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apk add --update openssh )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $VM_IPADDRESS >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "部署应用中..."
    - ssh $SSH_USER@$VM_IPADDRESS "cd $SSH_SITE_DIRECTORY && git pull && sh deploy.sh"
    - echo "应用已成功部署。"
  only:
    refs:
      - main
    changes:
      - apps/web-cn/**/*
      - packages/ui/**/*
      - .gitlab-ci.yml
deploy-api: # This job runs in the deploy-api stage.
  stage: deploy
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apk add --update openssh )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $VM_IPADDRESS >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "部署API中..."
    - ssh $SSH_USER@$VM_IPADDRESS "cd $SSH_SITE_DIRECTORY && git pull && sh deploy-api.sh"
    - echo "API已成功部署。"
  only:
    refs:
      - main
    changes:
      - apps/api-cn/**/*
      - .gitlab-ci.yml
